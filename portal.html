<!DOCTYPE html>
<html lang="hu" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RT Vasút Portál</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
        // JAVÍTVA: query és where importálása
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc, getDocs, onSnapshot, arrayUnion, Timestamp, query, where } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCWD3P7MnyW6dXg-bRXt3-q_NKzZKfuWYA",
            authDomain: "red-trains.firebaseapp.com",
            projectId: "red-trains",
            storageBucket: "red-trains.firebasestorage.app",
            messagingSenderId: "1053066929936",
            appId: "1:1053066929936:web:2034b7881af7c7febce795",
            measurementId: "G-5420S3F705"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const USERS_COLLECTION = 'users collection';  // Konstans a collection névhez
        
        // DOM elemek
        const authSection = document.getElementById('auth-section');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const adminSection = document.getElementById('admin-section');
        const userSection = document.getElementById('user-section');
        const userSelect = document.getElementById('user-id');
        const routeInput = document.getElementById('route');
        const dateInput = document.getElementById('date');
        const rankInput = document.getElementById('rank');
        const assignBtn = document.getElementById('assign-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const userList = document.getElementById('user-list');
        const myShifts = document.getElementById('my-shifts');
        const myRank = document.getElementById('my-rank');
        const newUserEmail = document.getElementById('new-user-email');
        const newUserPassword = document.getElementById('new-user-password');
        const createUserBtn = document.getElementById('create-user-btn');
        const messageText = document.getElementById('message-text');
        const sendMessageBtn = document.getElementById('send-message-btn');
        
        // --- JAVÍTOTT BLOKK KEZDETE ---
        // Auth állapot figyelés - JAVÍTVA
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                authSection.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                
                const userRef = doc(db, USERS_COLLECTION, user.uid);
                const userDoc = await getDoc(userRef);
                
                let userData; // Ebben tároljuk a végleges felhasználói adatot

                if (!userDoc.exists()) {
                    // Ha nincs doc, létrehozzuk az alapértelmezett adatokkal
                    userData = {
                        email: user.email || 'unknown',
                        shifts: [],
                        rank: '',
                        isAdmin: false // Alapból nem admin
                    };
                    await setDoc(userRef, userData);
                } else {
                    // Ha van doc, beolvassuk az adatát
                    userData = userDoc.data();
                }

                // Most már a 'userData' változó a mérvadó,
                // ami vagy a meglévő, vagy az épp most létrehozott adat.
                const isAdmin = userData.isAdmin === true; 

                if (isAdmin) {
                    adminSection.classList.remove('hidden');
                    loadUsers();
                } else {
                    userSection.classList.remove('hidden');
                    loadMyData(user.uid);
                }
            } else {
                authSection.classList.remove('hidden');
                adminSection.classList.add('hidden');
                userSection.classList.add('hidden');
                logoutBtn.classList.add('hidden');
            }
        });
        // --- JAVÍTOTT BLOKK VÉGE ---
        
        // Admin ellenőrzés Firestore-ból
        async function checkIfAdmin(uid) {
            const userDoc = await getDoc(doc(db, USERS_COLLECTION, uid));
            return userDoc.exists() && userDoc.data().isAdmin === true;
        }
        
        // Login
        loginBtn.addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, email, password).catch(err => alert(err.message));
        });
        
        // Logout
        logoutBtn.addEventListener('click', () => {
            signOut(auth)
                .then(() => {
                    alert('Sikeres kijelentkezés!');
                })
                .catch(err => alert('Hiba a kijelentkezéskor: ' + err.message));
        });
        
        // Új user létrehozás (admin) - automatikus inicializáló shift hozzáadása
        createUserBtn.addEventListener('click', async () => {
            const email = newUserEmail.value;
            const password = newUserPassword.value;
            if (!email || !password) return alert('Adj meg emailt és jelszót!');
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const uid = userCredential.user.uid;
                const initialShift = {
                    route: "Budapest-Debrecen",
                    date: "2025-12-01",
                    status: "pending",
                    createdAt: Timestamp.now()
                };
                await setDoc(doc(db, USERS_COLLECTION, uid), {
                    email: email,
                    shifts: [initialShift],
                    rank: '',
                    isAdmin: false
                });
                alert('User létrehozva inicializáló shift-tel!');
                loadUsers();
            } catch (err) {
                alert(err.message);
            }
        });
        
        // Shift és rang assign (admin)
        assignBtn.addEventListener('click', async () => {
            const uid = userSelect.value;
            const route = routeInput.value;
            const date = dateInput.value;
            const rank = rankInput.value;
            if (!uid) return alert('Válassz felhasználót!');
            if (!route && !date && !rank) return alert('Adj meg valamit!');
            try {
                const userRef = doc(db, USERS_COLLECTION, uid);
                const docSnap = await getDoc(userRef);
                const updates = {};
                if (route && date) {
                    const newShift = { route, date, status: 'pending', createdAt: Timestamp.now() };
                    if (!docSnap.exists()) {
                        await setDoc(userRef, { shifts: [newShift], rank: rank || '', email: 'unknown' });
                    } else {
                        updates.shifts = arrayUnion(newShift);
                    }
                }
                if (rank) updates.rank = rank;
                if (Object.keys(updates).length > 0) await updateDoc(userRef, updates);
                alert('Hozzárendelve!');
                loadUsers();
            } catch (err) {
                alert(err.message);
            }
        });
        
        // User törlés (admin) - csak Firestore, Auth-ot server-side töröld!
        deleteBtn.addEventListener('click', async () => {
            const uid = userSelect.value;
            if (!uid) return alert('Válassz felhasználót!');
            try {
                await deleteDoc(doc(db, USERS_COLLECTION, uid));
                alert('Felhasználó törölve (Firestore)!');
                loadUsers();
            } catch (err) {
                alert(err.message);
            }
        });
        
        // User lista betöltés (admin)
        async function loadUsers() {
            userSelect.innerHTML = '';
            userList.innerHTML = '';
            const snapshot = await getDocs(collection(db, USERS_COLLECTION));
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                const li = document.createElement('li');
                li.textContent = `Email: ${data.email || 'N/A'} - Rang: ${data.rank || 'Nincs'} - Admin: ${data.isAdmin ? 'Igen' : 'Nem'}`;
                userList.appendChild(li);
        
                const option = document.createElement('option');
                option.value = docSnap.id;
                option.textContent = data.email || docSnap.id;
                userSelect.appendChild(option);
            });
        }
        
        // Saját adatok betöltés real-time (user)
        function loadMyData(uid) {
            const userRef = doc(db, USERS_COLLECTION, uid);
            onSnapshot(userRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    myShifts.innerHTML = '';
                    (data.shifts || []).forEach((shift, index) => {
                        const li = document.createElement('li');
                        li.innerHTML = `${shift.route} - ${shift.date} - Státusz: ${shift.status}`;
                        const btns = ['confirmed', 'maybe', 'declined'].map(status => {
                            const btn = document.createElement('button');
                            btn.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                            btn.classList.add('bg-blue-500', 'text-white', 'p-1', 'ml-2', 'rounded');
                            btn.addEventListener('click', () => updateShiftStatus(uid, index, status));
                            return btn;
                        });
                        btns.forEach(btn => li.appendChild(btn));
                        myShifts.appendChild(li);
                    });
                    myRank.textContent = data.rank || 'Nincs rang';
                } else {
                    // Ha mégis nem létezik, mutass üzenetet
                    myShifts.innerHTML = '<li>Nincs adat, próbáld frissíteni az oldalt.</li>';
                }
            });
        }
        
        // Shift státusz frissítés (user)
        async function updateShiftStatus(uid, index, status) {
            const userRef = doc(db, USERS_COLLECTION, uid);
            const docSnap = await getDoc(userRef);
            if (docSnap.exists()) {
                const shifts = docSnap.data().shifts;
                shifts[index].status = status;
                await updateDoc(userRef, { shifts });
                alert('Státusz frissítve!');
            }
        }
        
        // --- JAVÍTOTT BLOKK KEZDETE (Optimalizált) ---
        // Üzenet küldés adminoknak (user)
        sendMessageBtn.addEventListener('click', async () => {
            const text = messageText.value;
            if (!text) return alert('Írj üzenetet!');
            try {
                // 1. Létrehozunk egy query-t, ami csak az adminokat kéri le
                const q = query(collection(db, USERS_COLLECTION), where("isAdmin", "==", true));
                
                // 2. Ezt a query-t futtatjuk le
                const adminsSnapshot = await getDocs(q); 
                
                const adminUids = [];
                // 3. Már csak az adminok vannak a snapshot-ban
                adminsSnapshot.forEach(d => { adminUids.push(d.id); }); 
                
                await setDoc(doc(db, 'messages', Date.now().toString()), {
                    from: auth.currentUser.uid,
                    to: adminUids,
                    text,
                    createdAt: Timestamp.now()
                });
                alert('Üzenet elküldve!');
                messageText.value = '';
            } catch (err) {
                alert(err.message);
                // Valószínűleg indexelési hiba. A konzolon kiír egy linket, arra kattintva hozd létre az indexet.
                if (err.code === 'failed-precondition') {
                    alert('Hiba: Valószínűleg hiányzik egy Firestore index. Ellenőrizd a böngésző konzolját a hiba részleteiért és a létrehozási linkért!');
                }
            }
        });
        // --- JAVÍTOTT BLOKK VÉGE ---
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="h-full bg-gray-100">

<nav class="bg-blue-800 p-4 text-white flex justify-between">
    <div class="text-xl font-bold">RT Vasút</div>
    <ul class="flex space-x-4">
        <li><a href="index.html" class="hover:underline">Főoldal</a></li>
        <li><a href="portal.html" class="hover:underline">Portál</a></li>
    </ul>
</nav>

<main class="p-8">
    <h1 class="text-2xl font-bold mb-4">Admin Portál</h1>

    <div id="auth-section" class="mb-6">
        <h2 class="text-xl font-semibold mb-2">Bejelentkezés</h2>
        <input type="email" id="email" placeholder="Email" class="border p-2 mb-2 w-full">
        <input type="password" id="password" placeholder="Jelszó" class="border p-2 mb-2 w-full">
        <button id="login-btn" class="bg-blue-600 text-white p-2 rounded">Bejelentkezés</button>
        <button id="logout-btn" class="bg-red-600 text-white p-2 rounded hidden">Kijelentkezés</button>
    </div>

    <div id="admin-section" class="hidden">
        <h2 class="text-xl font-semibold mb-2">Új Felhasználó Létrehozása</h2>
        <input type="email" id="new-user-email" placeholder="Új Email" class="border p-2 mb-2 w-full">
        <input type="password" id="new-user-password" placeholder="Új Jelszó" class="border p-2 mb-2 w-full">
        <button id="create-user-btn" class="bg-green-600 text-white p-2 rounded mb-4">Létrehozás</button>

        <h2 class="text-xl font-semibold mb-2">Shift és Rang Hozzárendelés</h2>
        <select id="user-id" class="border p-2 mb-2 w-full"></select>
        <input type="text" id="route" placeholder="Menet/Shift" class="border p-2 mb-2 w-full">
        <input type="date" id="date" placeholder="Dátum" class="border p-2 mb-2 w-full">
        <input type="text" id="rank" placeholder="Rang" class="border p-2 mb-2 w-full">
        <button id="assign-btn" class="bg-purple-600 text-white p-2 rounded mb-2">Hozzárendelés</button>
        <button id="delete-btn" class="bg-red-600 text-white p-2 rounded">Fiók törlése</button>

        <h2 class="text-xl font-semibold mt-6 mb-2">Felhasználói lista</h2>
        <ul id="user-list" class="border p-2 max-h-64 overflow-y-auto"></ul>
    </div>

    <div id="user-section" class="hidden">
        <h2 class="text-xl font-semibold mb-2">Beosztásaim</h2>
        <ul id="my-shifts" class="border p-2 max-h-64 overflow-y-auto"></ul>
        <p class="mt-2 font-semibold">Rang: <span id="my-rank"></span></p>

        <h2 class="text-xl font-semibold mt-6 mb-2">Üzenet az Adminoknak</h2>
        <textarea id="message-text" placeholder="Üzenet..." class="border p-2 mb-2 w-full h-24"></textarea>
        <button id="send-message-btn" class="bg-green-600 text-white p-2 rounded">Küldés</button>
    </div>
</main>

</body>
</html>
