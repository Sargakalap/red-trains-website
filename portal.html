<!DOCTYPE html>
<html lang="hu" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RT Vasút Portál</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="h-full bg-gray-100">

<nav class="bg-blue-800 p-4 text-white flex justify-between">
    <div class="text-xl font-bold">RT Vasút</div>
    <ul class="flex space-x-4">
        <li><a href="index.html" class="hover:underline">Főoldal</a></li>
        <li><a href="portal.html" class="hover:underline">Portál</a></li>
    </ul>
</nav>

<main class="p-8">
    <h1 class="text-2xl font-bold mb-4">Admin Portál</h1>
    
    <div id="auth-section" class="mb-6">
        <h2 class="text-xl font-semibold mb-2">Bejelentkezés</h2>
        <input type="email" id="email" placeholder="Email" class="border p-2 mb-2 w-full">
        <input type="password" id="password" placeholder="Jelszó" class="border p-2 mb-2 w-full">
        <button id="login-btn" class="bg-blue-600 text-white p-2 rounded">Bejelentkezés</button>
        <button id="logout-btn" class="bg-red-600 text-white p-2 rounded hidden">Kijelentkezés</button>
    </div>

    <div id="admin-section" class="hidden">
        <h2 class="text-xl font-semibold mb-2">Fiókok kezelése</h2>
        <input type="text" id="new-user-email" placeholder="Új felhasználó email" class="border p-2 mb-2 w-full">
        <input type="password" id="new-user-password" placeholder="Első jelszó" class="border p-2 mb-2 w-full">
        <button id="create-user-btn" class="bg-green-600 text-white p-2 rounded mb-4">Fiók létrehozása</button>

        <h2 class="text-xl font-semibold mb-2">Menetek és Rangok</h2>
        <input type="text" id="user-id" placeholder="Felhasználó ID" class="border p-2 mb-2 w-full">
        <input type="text" id="route" placeholder="Menet" class="border p-2 mb-2 w-full">
        <input type="text" id="rank" placeholder="Rang" class="border p-2 mb-2 w-full">
        <button id="assign-btn" class="bg-purple-600 text-white p-2 rounded mb-2">Hozzárendelés</button>
        <button id="delete-btn" class="bg-red-600 text-white p-2 rounded">Fiók törlése</button>

        <h2 class="text-xl font-semibold mt-6 mb-2">Felhasználói lista</h2>
        <ul id="user-list" class="border p-2 max-h-64 overflow-y-auto"></ul>
    </div>

    <div id="user-section" class="hidden">
        <h2 class="text-xl font-semibold mb-2">Beosztásaim</h2>
        <ul id="my-routes" class="border p-2 max-h-64 overflow-y-auto"></ul>
        <p class="mt-2 font-semibold">Rang: <span id="my-rank"></span></p>
    </div>
</main>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCWD3P7MnyW6dXg-bRXt3-q_NKzZKfuWYA",
  authDomain: "red-trains.firebaseapp.com",
  projectId: "red-trains",
  storageBucket: "red-trains.firebasestorage.app",
  messagingSenderId: "1053066929936",
  appId: "1:1053066929936:web:2034b7881af7c7febce795",
  measurementId: "G-5420S3F705"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const ADMIN_UIDS = ['Icxatttk0eTbALCDb5MjraZvyIX2', 'ADMIN_UID_2']; // Csak ezek az UID-k adminok

const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
loginBtn.addEventListener('click', () => {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    auth.signInWithEmailAndPassword(email, password)
        .then(userCredential => {
            const uid = userCredential.user.uid;
            document.getElementById('auth-section').classList.add('hidden');
            logoutBtn.classList.remove('hidden');
            if(ADMIN_UIDS.includes(uid)) {
                document.getElementById('admin-section').classList.remove('hidden');
                loadUsers();
            } else {
                document.getElementById('user-section').classList.remove('hidden');
                loadMyData(uid);
            }
        })
        .catch(err => alert(err.message));
});

logoutBtn.addEventListener('click', () => {
    auth.signOut().then(() => {
        document.getElementById('auth-section').classList.remove('hidden');
        document.getElementById('admin-section').classList.add('hidden');
        document.getElementById('user-section').classList.add('hidden');
        logoutBtn.classList.add('hidden');
    });
});

// Admin: Create User
document.getElementById('create-user-btn').addEventListener('click', () => {
    const email = document.getElementById('new-user-email').value;
    const password = document.getElementById('new-user-password').value;
    auth.createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
            const uid = userCredential.user.uid;
            db.collection('users').doc(uid).set({
                email: email,
                routes: [],
                rank: '',
                firstLogin: true // első belépéskor jelszócsere
            });
            alert('Felhasználó létrehozva! Az első jelszó: ' + password);
            loadUsers();
        })
        .catch(err => alert(err.message));
});

// Admin: Assign Routes and Rank
document.getElementById('assign-btn').addEventListener('click', () => {
    const uid = document.getElementById('user-id').value;
    const route = document.getElementById('route').value;
    const rank = document.getElementById('rank').value;
    db.collection('users').doc(uid).update({
        routes: firebase.firestore.FieldValue.arrayUnion(route),
        rank: rank
    })
    .then(() => {
        alert('Hozzárendelve!');
        loadUsers();
    })
    .catch(err => alert(err.message));
});

// Admin: Delete User
document.getElementById('delete-btn').addEventListener('click', () => {
    const uid = document.getElementById('user-id').value;
    db.collection('users').doc(uid).delete()
    .then(() => alert('Felhasználó törölve!'))
    .catch(err => alert(err.message));
});

// Load Users List
function loadUsers() {
    const list = document.getElementById('user-list');
    list.innerHTML = '';
    db.collection('users').get().then(snapshot => {
        snapshot.forEach(doc => {
            const li = document.createElement('li');
            li.textContent = `UID: ${doc.id} - Email: ${doc.data().email} - Rang: ${doc.data().rank}`;
            list.appendChild(li);
        });
    });
}

// Load own data
function loadMyData(uid) {
    db.collection('users').doc(uid).get().then(doc => {
        if(doc.exists){
            const data = doc.data();
            const routesEl = document.getElementById('my-routes');
            routesEl.innerHTML = '';
            data.routes.forEach(r => {
                const li = document.createElement('li');
                li.textContent = r;
                routesEl.appendChild(li);
            });
            document.getElementById('my-rank').textContent = data.rank;
            if(data.firstLogin){
                const newPass = prompt('Első belépés: kérlek add meg az új jelszavad');
                auth.currentUser.updatePassword(newPass).then(()=>{
                    db.collection('users').doc(uid).update({firstLogin:false});
                    alert('Jelszó frissítve!');
                });
            }
        }
    });
}
</script>

</body>
</html>
